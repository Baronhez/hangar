:imagesdir: ./images/setup-repository-script
= Setting up a repository on Azure DevOps using script

In this section we will create a repository on Azure DevOps in an automated way using a script. If you prefer using the Azure DevOps web interface, follow link:setup-repository-step-by-step.asciidoc[the step-by-step tutorial] instead.

NOTE: Here you will see two types of repository, Git repositories and Azure DevOps repositories, it is important to know that Azure DevOps repositories are still Git repositories, but in this documentation we will use Azure DevOps repository to talk about the one we want to create, and Git repository is about any other Git repository (it can be host on Github, on your local computer, on another Azure DevOps project ...)

== Prerequisites
In this part of the guide, we assume you have setup the Azure DevOps project and have Azure CLI installed and configured. If it is not the case, please go back and do so.

Additionally, you will need Git. In case you don't have it already installed, please refer to the https://git-scm.com/book/en/v2/Getting-Started-Installing-Git[official installation documentation].

== Using the script to create the repository

The script is located at `scripts/repositories/azure-devops/create_repo.bash`.

It can be used in different ways:

  - 1. Create an empty repository with just a README file and clone it to your computer into the directory you set.

  - 2. Import an already existing directory or Git repository into your project giving a path or an URL.


NOTE: For the first case, and the second case if your directory was not a Git repository, the repository is created with already some branches and branch policies. You can of course personalize them if needed.


Use the 1st case if this is a brand new repository. +
Use the 2nd case if you already started your code. +

=== Syntax +

```
  create_repo.bash
      [-a <String>]
      [-n <String>]
      [-d <String>]
      [-o <String>]
      [-p <String>]
      [-g <String>]
      [-b <string>]
      [-r]
      [-s]
      [-f]
```

=== Arguments +

```
  -a (for action) :       (Mandatory) The value of this will tell in which case the script must be executed, can be 'create' (1st case) or 'import'(2nd case).
  -n (for name) :         (Mandatory if the value of 'action' is 'create') Name the Azure DevOps repository will have.
                          If not set for action 'import', it will used the name of the Git repository you are trying to import or the name of the directory you will convert.
  -d (for directory) :    (Mandatory) Name of the directory where your repository will be cloned (for the action 'create' and 'import' if you used the -g flag), or name of the folder on your local machine you want to import (for the action 'import' if you did not use the -g flag).
  -o (for organization) : URL of your Azure DevOps organization (mandatory)
  -p (for project) :      (Mandatory) name of you Azure DevOps project
  -g (for giturl) :       URL of the Git repository you want to clone
  -b (for branch) :       If you mention this parameter it will be used in the case you used the action 'import, it will import your repository as is but will create a master and develop branch from the branch you gave (if they already exists they will be replace, be careful), if you gave an URL it will import only the branch you gave and then create master and develop.
  -r (for remove) :       If you gave a branch as reference when importing an existing git repository, it will delete all other branches.
  -s (for strategy) :     Set this flag if you want the script to create branch policies with the template this script uses.
  -f (for force) :        If you set this flag it will automatically say yes to every step where user confirmation is required.
```

==== Additional information

For the `-d`: The path can be relative or absolute.  +
You can use paths defined with backslashes because they will be converted into forward slashes, but be careful to write the path inside simple quote (or bash will try to interpret the backslashes).

For the `-o`: Be careful, this parameter is not the name of your organization, but the URL of it.

When you use the second case, If the `-g` flag is set it will import the Git repository with the URL and clone your repository inside the path set with the `-d` flag, if the `-g` flag is not set it will import the directory set with the `-d` flag.

For the `-r` flag, it will be ignored if you choose the action create, or you when try to import a local directory (because there is no existing branches before the execution of the script). +
The flag will also be ignored if you did not mention a reference branch with the `-b` flag.

The `-s` flag is ignored if you re trying to import an existing git repository and you did not set a branch with the `-b` flag.

=== Usage


==== 1st case: Creating a new repo +

===== Subcase a +
  /path/to/script/create_repo.bash -a 'create' -d /path/to/directory -o https://dev.azure.com/azure_organization -p azure_project -n repository_azure

This command creates a repository on Azure DevOps and clones it into our local directory, the creates *develop* and *master* branch.

===== Subcase b +
  /path/to/script/create_repo.bash -a 'create' -d /path/to/directory -o https://dev.azure.com/azure_organization -p azure_project -n repository_azure -s

This command creates the repository and clones it the same way the subcase a does it, then it creates the branch policies (see <<Branches and policies>> for more informations).

==== 2nd case: Importing a directory or a repository +
For the 2nd case, we will not give an exhaustive list of every combination of argument it is possible to use, but the list we give you will allow you to understand what you can do with them.

===== Subcase a +
  /path/to/script/create_repo.bash -a 'import' -d /path/to/directory -o  https://dev.azure.com/azure_organization -p azure_project -n repository_import -g https://github.com/user/repository.git

It will import all the content of the repository stored at that url `\https://github.com/user/repository.git` under the name *repository_import*, if no name would have been set, the repository would have been imported under the name *repository* (it uses the url to know the name). +
Then the repository is cloned inside the folder */path/to/directory*. +

NOTE: Importing a Git repository into Azure DevOps just imports the content (branchs, files ...), but once the repository is imported there is no link between them , any modification made on the original repo will not apply on your Azure DevOps project (and the other way around is also true). +

===== Subcase b +
  /path/to/script/create_repo.bash -a 'import' -d /path/to/directory -o  https://dev.azure.com/azure_organization -p azure_project -n repository_import -g https://github.com/user/repository.git -b reference -s -r

It will first import the repository stored at the url given the same way as it would in subcase a, then as a reference branch is given, it will create (or replace if they already exist) *master* and *develop* from this *reference* branch, then as the `-s` flag is set it will create the branch policies detailed here <<Branches and policies>>. As the `-r` flag is set, all branches except *reference*, *master* and *develop* will be deleted.

===== Subcase c: +
  /path/to/script/create_repo.bash -a 'import' -d /path/to/directory/repository_push -o https://dev.azure.com/azure_organization -p azure_project -n repository_push

If your folder */path/to/directory/repository_push* is just a folder, it will convert it into a Git repository, push it to your Azure DevOps project and create branches and branch policies. +
If your folder is a local Git repository, it will just push it to your Azure DevOps project. +
If your folder is an online Git repository, it will change the url so that next commits will be pushed into your Azure DevOps repository but not on the one already configured, and it will push all your branches at the new URL. +

===== Subcase d: +
  /path/to/script/create_repo.bash -a 'import' -d /path/to/directory/repository_push -o https://dev.azure.com/azure_organization -p azure_project -n repository_push -b reference -r -s

If your folder */path/to/directory/repository_push* is just a folder, it will act the exact same way as *2nd case c*. +
If your folder is a local Git repository, it will use the branch *reference* to create *develop* and *master* (it will replace them if they already exists), delete all other branches that the 3 given before (`-r` is set), then it will just push it to your Azure DevOps project and create the policies defined below (`-s` is set). +
If your folder is an online Git repository, the branch *develop* and *master* will be created the same way as if it was a local git repository, other branches that *master*, *develop* and *reference* will be deleted (`-r`), then it will change the URL so that next commits will be pushed into your Azure DevOps repository but not on the one already configured, after that it will push all your branches at the new URL. Finally it will create the policies defined below(`-s`). +

NOTE: `-r` and `-s` and independent, you can use one without the other it will not affect their use, but they are both dependent to `-b`.

==== Sample application

A repository containing a sample application exists, if you want to import it to your project, use the `2nd case a` with the URL: https://github.com/devonfw-sample/devon4quarkus-reference .

== Branches and policies

To ensure the quality of development, you will need to have a clean Git workflow. For a new repository or when pushing a regular folder as your Azure DevOps repository, we created a Git workflow.

=== Branches

We created 3 branches:

==== "develop"

This is the branch containing all finished development waiting for validation, every time you work on a new feature (or bug fix), you need to create a new branch, this branch must be created from *develop*, once your development is over, you can merge it into *develop* where validation tests will play on it. If these tests are successful, *develop* will be merged into *master*.


==== "master"

This branch contains every validated development ready to be released. It is from this branch we create release branches.


==== "feature/TEAM/featureName"

This branch is just for giving you an example of the template you can use for naming your feature branches.

NOTE: You should never commit directly on *develop* or *master*, modifications on *develop* should only come from merge of feature branches and modifications on *master* should only come from merge of *develop*.

=== Policies

You can define policies on your branches so you can secure them from commits not following certain rules. For example you can block squash merge.

Here are the policies we use as templates.

For the *develop* and *master* branch we have limited the type of merge that can be done.

==== master

image::master_policy.PNG[]

==== develop

image::develop_policy.PNG[]

==== Additional link

There are many other parameters you can use to define your branches policy, if you need to modify it, here is a link with more information about it. +
https://docs.microsoft.com/en-us/azure/devops/repos/git/branch-policies?view=azure-devops&tabs=browser
